<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>exist memory and stability | Bryan Lawrence</title>
  <meta name="description" content="Within ceda we are producing more and more xml documents, and the obvious tool for most of them is an xml database. At the moment there appears to be onlyone candidate in the opensource world that ...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://www.bnlawrence.net//computing/2008/11/exist_memory_and_stability/">
  <link rel="alternate" type="application/rss+xml" title="Bryan Lawrence" href="http://www.bnlawrence.net//feed.xml" />
<link rel='stylesheet' id='open-sans-css'  href='//fonts.googleapis.com/css?family=Open+Sans%3A300italic%2C400italic%2C600italic%2C300%2C400%2C600&#038;subset=latin%2Clatin-ext&#038;ver=4.2.4' type='text/css' media='all' />
<link href='http://fonts.googleapis.com/css?family=Titillium+Web:600italic,600,400,400italic' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="https://www.osu.edu/assets/fonts/webfonts.css">
<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">






<!-- Twitter cards -->
<meta name="twitter:site"    content="@bnlawrence">
<meta name="twitter:title"   content="exist memory and stability">


<meta name="twitter:description" content="Within ceda we are producing more and more xml documents, and the obvious tool for most of them is an xml database. At the moment there appears to be only
one candidate in the opensource world that...">



<meta name="twitter:card"  content="summary">
<meta name="twitter:image" content="">

<!-- end of Twitter cards -->

</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Bryan Lawrence</a>


    <nav class="site-nav">

      <a href="#" class="menu-icon menu.open">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

    <div class="trigger"><h1>Main Navigation</h1>

 <ul class="menu">

    
    
     <li><a href="/" class="page-link">Home</a>
    
    </li>
    
    
     <li><a href="/about/" class="page-link">About</a>
    
    </li>
    
    
    <li><a href="/academic/" class="page-link">Academic</a>
    <ul class="sub-menu">
    
    <li><a href="/academic/">Academic</a></li>
    
    <li><a href="/projects/">Projects</a></li>
    
    <li><a href="/publications/">Publications</a></li>
    
    <li><a href="/cv/">Short CV</a></li>
    
    <li><a href="/research/">Research</a></li>
    
    <li><a href="/talks/">Talks</a></li>
    
    </ul>
    
    </li>
    
    
     <li><a href="/blog/" class="page-link">Blog</a>
    
    </li>
    
    
     <li><a href="/search/" class="page-link">Find</a>
    
    </li>
    
    </ul>


     </div>
    </nav>
</div>
<div class="wrapper">
   <p> Intermittent rambings on climate, computing, or data science, what I'm up to, and what I'm thinking. Mostly professional, sometimes not.
 </p>
</div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

 <header class="post-header">
  <h1 class="post-title">exist memory and stability</h1>
  <p class="post-meta">Posted on November 14, 2008
  
  
      in
      
      <a href="/categories/#computing" title="computing">computing</a>&nbsp;
      
  
  
  
  (tagged: <a href="/tags/badc/" rel="tag">badc</a>).
  
  <br/>
  
  
  Previous Post: <a class="prev" href="/diary/2008/11/tales_from_the_sleep_deprived/">&laquo;tales from the sleep deprived&raquo;</a>
  
  
  (in <a href="/categories/#diary" title="diary">diary</a>;
  in <a href="/categories/#computing" title="computing">computing</a> previous is <a href="/computing/2008/11/lack_of_service/" class="prev">&laquo;lack of service&raquo;</a>)
  
  .<br/>
   Next Post <a class="next" href="/diary/2008/11/nearest_book/">&laquo;Nearest Book&raquo;</a>
  
  
  (in <a href="/categories/#diary" title="diary">diary</a>;
  in <a href="/categories/#computing" title="computing">computing</a> next is <a href="/computing/2009/01/curation_and_specification/" class="next">&laquo;curation and specification&raquo;</a>)
  
  .
  </p>
</header>


  <article class="post-content">
    <p>Within <a href="http://www.ceda.ac.uk">ceda</a> we are producing more and more xml documents, and the obvious tool for most of them is an xml database. At the moment there appears to be only
one candidate in the opensource world that has something approaching the necessary
reliability and scalablity: <a href="http://exist-db.org/">eXist</a>. Colleagues who have used or are using Berkeley xml database and xindice have been pretty scathing about their experiences, and I’m not aware of other options (although something interesting may be happening in the <a href="http://www.oreillynet.com/xml/blog/2007/12/xml_moves_to_mysql.html">mysql</a>and <a href="http://cafe.elharo.com/xml/the-state-of-native-xml-databases/#comment-247929">postgres</a> worlds). We’re not overly impressed with the reliability of eXist either, which is what I want to document here, but that said, we still believe it’s the way forward (e.g.<a href="http://cafe.elharo.com/xml/the-state-of-native-xml-databases/">in 2007</a> it was compared with MySQL circa 1997, which implies reasonable prospects).</p>

<p>We initially installed eXist in a tomcat container some years ago, and we’ve upgraded exist and tomcat a few times along the way. It’s only been this last year that we’ve started to get upwards of thousands of documents in exist, and it’s only in the last year that we’ve started to have
major stability problems, with many tomcat and eXist restarts necessary, and several restores from backup. We have observed problems with consistency when large document insertions via xquery over xmlrpc have been interupted, resulting in the necessity to rebuild collections. We have also seen the problems with collection indexes reported in <a href="http://exist.markmail.org/message/2wnwwdsz5xfu26i6">email</a> to the exist list.</p>

<p>A couple of weeks ago, we decied to reinstall exist in the jetty container, and see if we could identify what the problems were. Doing so has been a bit hairy. eXist is pretty well documented, but even so, the multitude of ways that eXist can be deployed (standalone database server, embedded database, or in the servlet engine of a Web application), leads to a considerable amount of ambiguity in documentation, and most importantly, signfiicant difficulties in working out which files are associated with the various memory <a href="http://exist-db.org/configuration.html">configuration options</a> (because which files control the memory depend on the deployment option). We’re pretty confident that at least some of our problems are memory related, and maybe where not the only folk in the same boat.</p>

<p>Anyway, herewith is what we think we need to do to control eXist when deployed as a service via the <em>tools/wrapper/bin/exist.sh</em> wrapper. Firstly, there are at least two places we think that the memory available to the processes can be configured:</p>
<ul>
  <li><strong>tools/wapper/conf/wrapper.conf</strong> where we (now) find the process memory configuration</li>
</ul>
<pre>
# Initial Java Heap Size (in MB)
wrapper.java.initmemory=64
# Maximum Java Heap Size (in MB)
wrapper.java.maxmemory=512
</pre>
<p>and</p>
<ul>
  <li><strong>conf.xml</strong>, where we find the db-connection configuration</li>
</ul>
<pre>
&lt;db-connection cacheSize="256M" collectionCache="124M" database="native"
        files="/disks/databases/exist" pageSize="4096"&gt;
</pre>
<p>where we are warned that 
    * <em>the cacheSize should not be more than half the size of the
JVM heap size</em>, which is not in this case, set (directly) by the JVM -Xmx parameter but by the
wrapper. Just that one misconception alone tooks us ages to track down, and;
    * wrt collectionCache, <em>…if our collections are very different in size, it might be possible that the actual amount
of memory used exceeds the specified limit. You should thus be careful with this setting.</em>
Huh? So how do I be careful? What should I look for?</p>

<p>We think the setting we have 
should be ok because we have seen the eXist developers saying this should be ok
in <a href="http://exist.markmail.org/message/wf6ez3eva5z2fvdn">other emai</a>l. But … we’re not happy with not knowing … is this a failure mode or a performance problem setting?</p>

<p>Then, and worryingly, because some of our problems seem to occur in processing xqueries, we find in (old) <a href="http://markmail.org/message/vtb54545ki4rvsss">email</a> from an eXist developer (in an interesting thread) that</p>
<blockquote>cacheSize just limits the size of the page cache, i.e. the number of data file pages cached in memory. This does not include the base memory needed by eXist (and the libraries it uses) for XML processing and querying. 
</blockquote>

<p>which is probably why they recommend not having it larger than half. But what happens when those libraries blow out their memory requirements?</p>

<p>We haven’t yet resorted to turning off full text indexing, because we want that, but we could try the upgrade mentioned in the eXist developer email. We’re currently on 1.2.4-rev:8072-20080802.</p>

<p>At this point we haven’t yet set a java expert on our problems, but I guess we might have to (following the sort of thing done <a href="http://exist.markmail.org/message/vct6erw5rho26kfy">here</a>).  Meanwhile, this post is by way of notes for later (and maybe a brief for such an expert).</p>

  </article>

  


</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">
    <hr/>
<!--     <h2 class="footer-heading">Bryan Lawrence</h2> -->

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li><strong>Bryan Lawrence</strong></li>
		  <li>Professional Meeting Attendee</li>
          <li><a href="mailto:b.n.lawrence@reading.ac.uk">b.n.lawrence@reading.ac.uk</a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">

          
          <li>
              <a href="https://github.com/bnlawrence">
              <i class="fa fa-github" style="color:gray"></i> bnlawrence
             </a>
          </li>
          

          
          <li>
             <a href="https://twitter.com/bnlawrence">
             <i class="fa fa-twitter" style="color:gray"></i> bnlawrence
             </a>
          </li>
          

        </ul>
      </div>

      <div class="footer-col  footer-col-3">
         <p class="text">
	     This is a personal site. Caveat Lector. Nothing written here reflects an official opinion of my employer or any funding agency. Laboris locatores analogum obsecro respice auferetur. (My daughter is learning Latin, unlike me, who never did!)

      </div>
    </div>
    <!--
    <hr/>
    <p class="text"> This is a personal site. Caveat Lector. Nothing written here reflects an official opinion of my employer or any funding agency. Laboris locatores analogum obsecro respice auferetur. (My daughter is learning Latin, unlike me, who never did!)
 </p>
    -->

  </div>

</footer>

    
    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-111008496-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-111008496-1');
</script>

    
  </body>


</html>
<!-- d.050600.062508.030515.080516 | "Baby, I'm Yours" -->
